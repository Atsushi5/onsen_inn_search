import os
import sys
import matplotlib.pyplot as plt
#import seaborn as sns; sns.set()  # for plot styling
import numpy as np
from sklearn.cluster import KMeans

sys.path.append("..")
sys.path.append("../..")
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'onsen_inn_search.setting\
s')
import django
django.setup()

from onsen_inns.models import Onsen, OnsenInn

from sklearn.datasets.samples_generator import make_blobs


data_list = ["inn_min_price", "review_room", "review_bath", "review_breakfast", "review_dinner", "review_service", "review_cleaness", "rooms_total", "baths_total", "free_wifi", "convenience_store", "hand_towel", "dental_amenities", "bath_towel", "shampoo", "conditioner", "body_wash", "bar_soap", "yukata", "pajamas", "bathrobe", "hairdryer", "duvet", "razor", "shower_cap", "cotton_swab", "onsui_toilet", "hair_brush"]

def main():
    # data processing

    # fetch data from our database and convert it into numpy array
    data_set = []
    onsen_inns = OnsenInn.objects.all()
    for entry in data_list:
        data_set.append(onsen_inns.values_list(entry))

    data_set = np.array(data_set, dtype=np.float)
    #data_set = np.array(data_set)
    data_set = data_set.transpose()
    data_set = data_set[0]
    print(data_set.dtype)
    #print(data_set)
    data_set = data_set[:, ~np.isnan(data_set).any(axis=0)]
    
    # plot onsen inn data
    '''X, y_true = make_blobs(n_samples=300, centers=4,
                       cluster_std=0.60, random_state=0)
    file = plt.figure()
    plt.scatter(X[:, 0], X[:, 1], s=50)
    plt.show()
    file.savefig("plot.pdf")'''
    
    
    # apply k-means clustering
    kmeans = KMeans(n_clusters=15)
    kmeans.fit(data_set)
    y_kmeans = kmeans.predict(data_set)

    file = plt.figure()
    plt.scatter(data_set[:,0], data_set[:,1], c=y_kmeans, s=50)
    plt.show()
    file.savefig("plot.pdf")

def store_clustering_result(result):
    for i, onsen_inn, category in enumerate(zip(OnsenInn.objects.all(), result)):
        onsen_inn.category =  category
        onsen_inn.save()
    


if __name__ == "__main__":

    main()
